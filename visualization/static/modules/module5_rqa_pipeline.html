<!-- RQA分析流程模块内容 -->
<div class="container-fluid">
    <div class="rqa-pipeline-header">
        <h2><i class="fas fa-cogs"></i> <span data-lang-key="rqaPipelineTitle">RQA分析流程</span></h2>
        <p class="lead" data-lang-key="rqaPipelineDescription">完整的眼动数据递归量化分析流程，从数据处理到统计分析再到可视化</p>
    </div>

    <!-- 参数配置面板 -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapse('rqaParams')">
            <h4><i class="fas fa-sliders-h"></i> RQA参数配置</h4>
            <button class="collapsible-toggle" id="rqaParamsToggle">−</button>
        </div>
        <div class="collapsible-content" id="rqaParamsContent">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="pipeline-params-panel">
                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label for="rqa-embedding-dim" class="form-label">嵌入维度 (m):</label>
                                <input type="number" class="form-control" id="rqa-embedding-dim" value="2" min="1" max="10" onchange="updateParamSignature()">
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label for="rqa-time-delay" class="form-label">时间延迟 (τ):</label>
                                <input type="number" class="form-control" id="rqa-time-delay" value="1" min="1" max="20" onchange="updateParamSignature()">
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label for="rqa-threshold" class="form-label">递归阈值 (ε):</label>
                                <input type="number" class="form-control" id="rqa-threshold" value="0.05" min="0.001" max="1" step="0.001" onchange="updateParamSignature()">
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label for="rqa-min-line" class="form-label">最小线长 (l_min):</label>
                                <input type="number" class="form-control" id="rqa-min-line" value="2" min="1" max="50" onchange="updateParamSignature()">
                            </div>
                        </div>
                        <div class="param-info">
                            <div class="row">
                                <div class="col-lg-8">
                                    <strong>当前参数组合:</strong> <span id="current-param-signature" class="param-signature">m2_tau1_eps0.05_lmin2</span>
                                </div>
                                <div class="col-lg-4 text-end">
                                    <button class="btn btn-sm btn-outline-info" onclick="loadParamHistory()">
                                        <i class="fas fa-history"></i> 历史参数
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GPU加速模式控制面板 (新增) -->
    <div class="card border-success mb-3">
        <div class="card-header bg-success text-white">
            <h5><i class="fas fa-rocket"></i> GPU并行加速</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableGpuMode" checked>
                        <label class="form-check-label" for="enableGpuMode">
                            <strong>启用GPU加速</strong>
                            <small class="text-muted d-block">RTX 3080 Mobile (16GB)</small>
                        </label>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label"><strong>并行任务数</strong></label>
                    <input type="number" class="form-control" id="parallelWorkers" value="4" min="1" max="6">
                    <small class="text-muted">建议4-6个</small>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info mb-0">
                        <strong>预计耗时</strong><br>
                        <span id="estimatedTime">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 批处理配置面板 (新增) -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapse('batchConfig')">
            <h4><i class="fas fa-layer-group"></i> 批量处理配置</h4>
            <button class="collapsible-toggle" id="batchConfigToggle">−</button>
        </div>
        <div class="collapsible-content" id="batchConfigContent">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>批量执行说明：</strong> 自动生成多组参数组合，依次执行完整的5步RQA流程。配置各参数的范围后，系统将自动生成所有可能的参数组合并批量执行。
                    </div>
                </div>
            </div>

            <!-- 参数范围配置 -->
            <div class="row">
                <!-- m维度范围 -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label"><strong>嵌入维度 (m)</strong></label>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">起始</span>
                        <input type="number" class="form-control batch-param-input" id="batch-m-start" value="1" min="1" max="10">
                    </div>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">结束</span>
                        <input type="number" class="form-control batch-param-input" id="batch-m-end" value="10" min="1" max="10">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">步长</span>
                        <input type="number" class="form-control batch-param-input" id="batch-m-step" value="1" min="1" max="5">
                    </div>
                </div>

                <!-- τ时间延迟范围 -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label"><strong>时间延迟 (τ)</strong></label>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">起始</span>
                        <input type="number" class="form-control batch-param-input" id="batch-tau-start" value="1" min="1" max="20">
                    </div>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">结束</span>
                        <input type="number" class="form-control batch-param-input" id="batch-tau-end" value="10" min="1" max="20">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">步长</span>
                        <input type="number" class="form-control batch-param-input" id="batch-tau-step" value="1" min="1" max="10">
                    </div>
                </div>

                <!-- ε递归阈值范围 -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label"><strong>递归阈值 (ε)</strong></label>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">起始</span>
                        <input type="number" class="form-control batch-param-input" id="batch-eps-start" value="0.05" min="0.001" max="1" step="0.01">
                    </div>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">结束</span>
                        <input type="number" class="form-control batch-param-input" id="batch-eps-end" value="0.1" min="0.001" max="1" step="0.01">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">步长</span>
                        <input type="number" class="form-control batch-param-input" id="batch-eps-step" value="0.01" min="0.001" max="0.1" step="0.001">
                    </div>
                </div>

                <!-- l_min最小线长范围 -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label"><strong>最小线长 (l_min)</strong></label>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">起始</span>
                        <input type="number" class="form-control batch-param-input" id="batch-lmin-start" value="2" min="1" max="50">
                    </div>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">结束</span>
                        <input type="number" class="form-control batch-param-input" id="batch-lmin-end" value="3" min="1" max="50">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">步长</span>
                        <input type="number" class="form-control batch-param-input" id="batch-lmin-step" value="1" min="1" max="10">
                    </div>
                </div>
            </div>

            <!-- 预览与执行 -->
            <div class="row mt-3">
                <div class="col-lg-8">
                    <div class="alert alert-success mb-0">
                        <strong><i class="fas fa-calculator"></i> 预计生成:</strong>
                        <span id="batch-combination-count" class="fs-4 fw-bold">1200</span> 个参数组合
                        <br>
                        <small class="text-muted">基于以上参数范围自动计算</small>
                    </div>
                </div>
                <div class="col-lg-4">
                    <button class="btn btn-lg btn-success w-100" onclick="startBatchExecution()">
                        <i class="fas fa-rocket"></i> 开始批量执行
                    </button>
                    <small class="text-muted d-block mt-2 text-center">将依次执行5步流程</small>
                </div>
            </div>

            <!-- 批处理进度面板 -->
            <div class="row mt-4" id="batchProgressPanel" style="display: none;">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-tasks"></i> 批处理执行进度</h5>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 35px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                     id="batchProgressBar" role="progressbar"
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                     <span class="fs-5 fw-bold">0%</span>
                                </div>
                            </div>
                            <div id="batchProgressText" class="text-center mb-2">
                                <i class="fas fa-spinner fa-spin"></i> 准备启动批处理...
                            </div>
                            <div id="batchProgressStats" class="row text-center mt-3">
                                <div class="col-3">
                                    <div class="border rounded p-2">
                                        <div class="text-muted small">总计</div>
                                        <div class="fs-4 fw-bold" id="batch-total">0</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="border rounded p-2 bg-success-subtle">
                                        <div class="text-muted small">成功</div>
                                        <div class="fs-4 fw-bold text-success" id="batch-completed">0</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="border rounded p-2 bg-warning-subtle">
                                        <div class="text-muted small">跳过</div>
                                        <div class="fs-4 fw-bold text-warning" id="batch-skipped">0</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="border rounded p-2 bg-danger-subtle">
                                        <div class="text-muted small">失败</div>
                                        <div class="fs-4 fw-bold text-danger" id="batch-failed">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 流程步骤卡片 -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapse('pipelineSteps')">
            <h4><i class="fas fa-cogs"></i> 分析流程</h4>
            <button class="collapsible-toggle" id="pipelineStepsToggle">−</button>
        </div>
        <div class="collapsible-content" id="pipelineStepsContent">
            <div class="row">
                <!-- 步骤1: RQA计算 -->
                <div class="col-lg-4 mb-4">
                    <div class="pipeline-step-card" id="step1Card">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h4>RQA计算模块</h4>
                        </div>
                        <div class="step-content">
                            <p>对眼动轨迹数据进行递归量化分析，计算RR、DET、ENT指标</p>
                            <div class="step-details">
                                <li>1D信号分析 (X坐标)</li>
                                <li>2D信号分析 (X,Y坐标)</li>
                                <li>相空间重构与递归矩阵</li>
                            </div>
                            <button class="btn btn-primary step-btn" onclick="startRQACalculation()">
                                <i class="fas fa-play"></i> 开始计算
                            </button>
                            <div class="step-status" id="step1Status">
                                <i class="fas fa-clock text-warning"></i> 待执行
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤2: 数据合并 -->
                <div class="col-lg-4 mb-4">
                    <div class="pipeline-step-card" id="step2Card">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h4>数据合并模块</h4>
                        </div>
                        <div class="step-content">
                            <p>整合Control、MCI、AD三组数据，生成统一数据表</p>
                            <div class="step-details">
                                <li>添加组别标识</li>
                                <li>统一ID格式</li>
                                <li>数据质量检查</li>
                            </div>
                            <button class="btn btn-secondary step-btn" onclick="startDataMerging()">
                                <i class="fas fa-layer-group"></i> 合并数据
                            </button>
                            <div class="step-status" id="step2Status">
                                <i class="fas fa-clock text-warning"></i> 待执行
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤3: 特征补充 -->
                <div class="col-lg-4 mb-4">
                    <div class="pipeline-step-card" id="step3Card">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <h4>特征补充模块</h4>
                        </div>
                        <div class="step-content">
                            <p>补充眼动事件特征和ROI统计信息</p>
                            <div class="step-details">
                                <li>注视时长与次数</li>
                                <li>扫视幅度与速度</li>
                                <li>ROI回视统计</li>
                            </div>
                            <button class="btn btn-info step-btn" onclick="startFeatureEnrichment()">
                                <i class="fas fa-plus-circle"></i> 补充特征
                            </button>
                            <div class="step-status" id="step3Status">
                                <i class="fas fa-clock text-warning"></i> 待执行
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- 步骤4: 统计分析 -->
                <div class="col-lg-6 mb-4">
                    <div class="pipeline-step-card" id="step4Card">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <h4>统计分析模块</h4>
                        </div>
                        <div class="step-content">
                            <p>对合并数据进行多层次统计分析</p>
                            <div class="step-details">
                                <li>组别间差异分析</li>
                                <li>任务效应分析</li>
                                <li>描述性统计</li>
                            </div>
                            <button class="btn btn-success step-btn" onclick="startStatisticalAnalysis()">
                                <i class="fas fa-chart-bar"></i> 统计分析
                            </button>
                            <div class="step-status" id="step4Status">
                                <i class="fas fa-clock text-warning"></i> 待执行
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤5: 可视化 -->
                <div class="col-lg-6 mb-4">
                    <div class="pipeline-step-card" id="step5Card">
                        <div class="step-header">
                            <div class="step-number">5</div>
                            <h4>可视化模块</h4>
                        </div>
                        <div class="step-content">
                            <p>生成统计图表和分析报告</p>
                            <div class="step-details">
                                <li>组级RQA指标条形图</li>
                                <li>任务间变化折线图</li>
                                <li>统计报告导出</li>
                            </div>
                            <button class="btn btn-warning step-btn" onclick="startVisualization()">
                                <i class="fas fa-chart-line"></i> 生成图表
                            </button>
                            <div class="step-status" id="step5Status">
                                <i class="fas fa-clock text-warning"></i> 待执行
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局控制面板 -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapse('globalControls')">
            <h4><i class="fas fa-cog"></i> 全局控制</h4>
            <button class="collapsible-toggle" id="globalControlsToggle">−</button>
        </div>
        <div class="collapsible-content" id="globalControlsContent">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="pipeline-control-panel">
                        <div class="row">
                            <div class="col-lg-6">
                                <button class="btn btn-lg btn-primary w-100" onclick="runFullPipeline()">
                                    <i class="fas fa-play-circle"></i> 运行完整流程
                                </button>
                            </div>
                            <div class="col-lg-6">
                                <button class="btn btn-lg btn-outline-secondary w-100" onclick="resetPipeline()">
                                    <i class="fas fa-redo"></i> 重置流程
                                </button>
                            </div>
                        </div>
                        <div class="pipeline-progress mt-3">
                            <label>总体进度:</label>
                            <div class="progress">
                                <div class="progress-bar" id="overallProgress" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果展示区域 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="pipeline-results">
                <h4><i class="fas fa-chart-area"></i> 分析结果</h4>
                <div class="results-container" id="pipelineResults">
                    <div class="placeholder-content text-center py-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">尚未生成分析结果</h5>
                        <p class="text-muted">请运行分析流程以查看结果</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>