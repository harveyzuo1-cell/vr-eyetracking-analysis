# VR眼动数据分析平台 - 模块重组方案

## 📋 文档概述

**目的**: 梳理清楚新旧项目的模块对应关系,制定合理的模块迁移和重组方案
**背景**: 旧项目有10个模块,新项目已实现Module01,需要规划后续模块的架构
**日期**: 2025-10-01

---

## 🔍 问题分析

### 当前状况

#### 新项目已完成:
- ✅ **Module01**: 原始数据查看与可视化
  - 功能: 数据加载、眼动轨迹图、热力图
  - 数据源: `data/01_raw/`
  - 前后端: React + Flask API完整实现

#### 旧项目模块清单:
1. **模块1**: 数据可视化 (与新Module01功能重叠)
2. **模块2**: 数据导入 (功能应整合到Module01)
3. **模块3**: RQA分析 (单次分析)
4. **模块4**: 事件分析 (IVT算法)
5. **模块5**: RQA批处理流程 (参数网格搜索)
6. **模块6**: 综合特征提取
7. **模块7**: 数据整合
8. **模块8**: MMSE对比分析
9. **模块9**: 机器学习预测
10. **模块10**: Eye-Index综合评估 (ABCDE五个子模块)

### 核心冲突点

1. **功能重叠**: 旧模块1、2都涉及数据查看,与新Module01重叠
2. **RQA分散**: 旧模块3、5都是RQA分析,需要合并
3. **数据流不清晰**: 6阶段数据流(01_raw → 06_results)与模块编号不对应

---

## 🎯 重组方案 (推荐方案A)

### 核心设计原则

1. **数据流导向**: 模块编号对应6阶段数据目录
2. **功能内聚**: 相关功能合并到同一模块
3. **向后兼容**: 保留旧项目核心算法和数据格式

### 新模块架构

#### **Module 00: 数据管理中心** (新增)
- **功能定位**: 统一的数据导入、上传、预览、导出中心
- **对应旧模块**: 模块2(数据导入)
- **数据源**: 无固定来源
- **数据输出**: `data/01_raw/`
- **核心功能**:
  - 多文件拖拽上传
  - CSV/TXT格式验证
  - 数据预览和质量检查
  - 批量导入管理
  - 数据导出(各阶段数据)

#### **Module 01: 原始数据可视化** (已完成✅)
- **功能定位**: 原始眼动数据的查看和基础可视化
- **对应旧模块**: 模块1(数据可视化)的部分功能
- **数据源**: `data/01_raw/`
- **数据输出**: 无(仅可视化)
- **核心功能**:
  - 眼动轨迹可视化
  - 热力图生成
  - 数据统计摘要
  - 组别/受试者/任务选择

#### **Module 02: 数据预处理** (规划中)
- **功能定位**: 数据清洗、去噪、滤波
- **对应旧模块**: 新功能(旧项目未明确分离)
- **数据源**: `data/01_raw/`
- **数据输出**: `data/02_preprocessed/`
- **核心功能**:
  - 异常值检测和处理
  - 数据平滑(移动平均、高斯滤波)
  - 缺失值插补
  - 采样率标准化
  - 坐标系转换

#### **Module 03: 数据校准** (规划中)
- **功能定位**: 眼动数据的精确校准
- **对应旧模块**: 模块1中的校准功能
- **数据源**: `data/02_preprocessed/`
- **数据输出**: `data/03_calibrated/`
- **核心功能**:
  - 时间对齐(VR任务时间 vs 眼动时间)
  - 空间校准(屏幕坐标映射)
  - ROI区域定义和映射
  - 速度和加速度计算
  - 校准参数调优界面

#### **Module 04: 特征提取** (规划中)
- **功能定位**: 多维度眼动特征的自动提取
- **对应旧模块**: 模块3(RQA) + 模块4(事件分析) + 模块6(综合特征)
- **数据源**: `data/03_calibrated/`
- **数据输出**: `data/04_features/`
- **子功能模块**:

  **4A. RQA递归量化分析**:
  - 单次RQA计算(旧模块3)
  - 批量RQA参数网格搜索(旧模块5)
  - GPU加速并行计算
  - 1D/2D RQA指标: RR, DET, LAM, ENTR等
  - 递归图可视化

  **4B. 眼动事件检测**:
  - IVT算法注视点检测(旧模块4)
  - 扫视检测和分类
  - 眼跳(Saccade)参数提取
  - ROI访问模式分析
  - 事件序列统计

  **4C. 统计特征提取**:
  - 游戏时长、ROI停留时间
  - 轨迹长度、速度分布
  - 注视点密度、扫视幅度
  - 空间分布特征

#### **Module 05: 数据整合** (规划中)
- **功能定位**: 多源特征整合、归一化、数据集构建
- **对应旧模块**: 模块7(数据整合)
- **数据源**: `data/04_features/` + `data/MMSE_Score/`
- **数据输出**: `data/05_datasets/`
- **核心功能**:
  - 特征整合(RQA + 事件 + 统计)
  - MMSE分数关联
  - 特征归一化(Min-Max, Z-score)
  - 特征方向统一(确保正相关)
  - 训练集/验证集/测试集划分
  - NPZ/CSV数据集导出

#### **Module 06: 数据分析** (规划中)
- **功能定位**: 统计分析、相关性分析、探索性数据分析
- **对应旧模块**: 模块8(MMSE对比分析)
- **数据源**: `data/05_datasets/`
- **数据输出**: `data/06_results/analysis/`
- **核心功能**:
  - 组间差异分析(Control vs MCI vs AD)
  - 特征-MMSE相关性分析
  - 眼动系数算法(Eye-Index)
  - Q1-Q5任务子分数分析
  - 多维度可视化(散点图、箱线图、热力图)

#### **Module 07: 机器学习预测** (规划中)
- **功能定位**: 传统机器学习模型训练和预测
- **对应旧模块**: 模块9(机器学习预测)
- **数据源**: `data/05_datasets/`
- **数据输出**: `data/06_results/ml_models/`
- **核心功能**:
  - 分类模型(Control/MCI/AD三分类)
  - 回归模型(MMSE分数预测)
  - 模型选择: Random Forest, SVM, XGBoost等
  - 交叉验证和超参数优化
  - 特征重要性分析
  - 模型性能评估和可视化

#### **Module 08: 深度学习预测** (规划中)
- **功能定位**: PyTorch深度学习模型训练
- **对应旧模块**: 模块10-B(模型训练)
- **数据源**: `data/05_datasets/`
- **数据输出**: `data/06_results/dl_models/`
- **核心功能**:
  - MLP多层感知机训练
  - Q1-Q5任务特定模型
  - TensorBoard训练监控
  - 早停、学习率调度
  - 模型检查点管理

#### **Module 09: 模型评估与服务** (规划中)
- **功能定位**: 模型性能评估和推理服务
- **对应旧模块**: 模块10-C(模型服务) + 模块10-D(性能评估)
- **数据源**: `data/06_results/ml_models/` + `data/06_results/dl_models/`
- **数据输出**: `data/06_results/evaluation/`
- **核心功能**:
  - 批量模型评估
  - 残差分析(个体、任务、组别三维)
  - 模型对比可视化
  - 在线预测API服务
  - 模型版本管理

#### **Module 10: Eye-Index综合评估** (规划中)
- **功能定位**: 综合认知功能评估系统
- **对应旧模块**: 模块10-A(数据准备) + 模块10-E(关联可视化)
- **数据源**: 全部数据阶段
- **数据输出**: `data/06_results/eye_index/`
- **核心功能**:
  - Eye-Index综合指标计算
  - 多模态数据融合
  - 认知功能综合报告生成
  - 临床决策支持可视化
  - 个体认知画像

---

## 🔄 数据流图

### 6阶段数据流 + 模块对应关系

```
┌─────────────────────────────────────────────────────────────────┐
│                     VR眼动数据分析平台                            │
│                   6-Stage Data Pipeline                          │
└─────────────────────────────────────────────────────────────────┘

📦 Stage 0: 数据导入
   [Module 00: 数据管理中心]
   └─> 上传、导入、格式转换
        │
        ↓
📊 Stage 1: 原始数据 (data/01_raw/)
   [Module 01: 原始数据可视化]
   └─> 轨迹图、热力图、统计摘要
        │
        ↓
🔧 Stage 2: 预处理数据 (data/02_preprocessed/)
   [Module 02: 数据预处理]
   └─> 去噪、滤波、异常值处理
        │
        ↓
📏 Stage 3: 校准数据 (data/03_calibrated/)
   [Module 03: 数据校准]
   └─> 时间对齐、空间校准、ROI映射
        │
        ↓
🎯 Stage 4: 特征数据 (data/04_features/)
   [Module 04: 特征提取]
   ├─> 4A. RQA递归量化分析
   ├─> 4B. 眼动事件检测
   └─> 4C. 统计特征提取
        │
        ↓
📦 Stage 5: 数据集 (data/05_datasets/)
   [Module 05: 数据整合]
   └─> 特征整合、归一化、数据集构建
        │
        ├─────────────────┬─────────────────┬─────────────────┐
        ↓                 ↓                 ↓                 ↓
   📊 Module 06:     🤖 Module 07:    🧠 Module 08:    📈 Module 09:
   数据分析          机器学习          深度学习          模型评估
   (统计分析)        (传统ML)         (PyTorch)        (性能评估)
        │                 │                 │                 │
        └─────────────────┴─────────────────┴─────────────────┘
                                    ↓
                        📊 Stage 6: 结果 (data/06_results/)
                            [Module 10: Eye-Index综合评估]
                            └─> 综合认知功能评估报告
```

---

## 📋 旧模块与新模块对应表

| 旧项目模块 | 新项目模块 | 合并/拆分策略 | 优先级 |
|-----------|-----------|--------------|--------|
| **模块1**: 数据可视化 | Module 01 + Module 03(部分) | 拆分: 可视化→01, 校准→03 | P0 ✅完成 |
| **模块2**: 数据导入 | Module 00 | 整合: 统一数据管理中心 | P1 |
| **模块3**: RQA分析 | Module 04-A | 合并: RQA单次分析 | P1 |
| **模块4**: 事件分析 | Module 04-B | 合并: 眼动事件检测 | P1 |
| **模块5**: RQA批处理 | Module 04-A | 合并: RQA批量处理 | P2 |
| **模块6**: 综合特征提取 | Module 04-C + Module 05 | 拆分: 提取→04-C, 整合→05 | P1 |
| **模块7**: 数据整合 | Module 05 | 直接对应 | P1 |
| **模块8**: MMSE对比 | Module 06 | 扩展: 统计分析模块 | P2 |
| **模块9**: 机器学习 | Module 07 | 直接对应 | P2 |
| **模块10-A**: 数据准备 | Module 05 | 整合: 数据集构建 | P2 |
| **模块10-B**: 模型训练 | Module 08 | 直接对应: 深度学习 | P2 |
| **模块10-C**: 模型服务 | Module 09 | 合并: 服务+评估 | P2 |
| **模块10-D**: 性能评估 | Module 09 | 合并: 服务+评估 | P2 |
| **模块10-E**: 关联可视化 | Module 10 | 整合: 综合评估 | P3 |

---

## 🚀 实施路线图

### Phase 1: 数据处理基础 (2-3周)

**目标**: 完成从原始数据到校准数据的完整流程

1. **Module 00: 数据管理中心** [5天]
   - 文件上传组件(React Dropzone)
   - 数据验证和预览
   - 批量导入管理界面

2. **Module 02: 数据预处理** [5天]
   - 异常值检测算法(移植旧代码)
   - 数据平滑和滤波
   - 预处理参数配置界面

3. **Module 03: 数据校准** [5天]
   - 时间对齐算法
   - 空间校准界面
   - ROI定义工具
   - 校准效果可视化

### Phase 2: 特征提取核心 (3-4周)

**目标**: 实现完整的特征提取管道

4. **Module 04-A: RQA分析** [7天]
   - 单次RQA计算(CPU版本)
   - GPU加速版本(CuPy迁移)
   - 参数网格搜索
   - 递归图可视化

5. **Module 04-B: 事件检测** [5天]
   - IVT算法实现
   - 注视/扫视分类
   - ROI访问分析
   - 事件序列可视化

6. **Module 04-C: 统计特征** [3天]
   - 基础统计特征提取
   - 特征计算工具类
   - 特征可视化界面

### Phase 3: 数据整合与分析 (2周)

**目标**: 构建标准化数据集和统计分析

7. **Module 05: 数据整合** [5天]
   - 多源特征整合
   - MMSE数据关联
   - 特征归一化管道
   - NPZ数据集生成

8. **Module 06: 数据分析** [5天]
   - 组间差异分析
   - 相关性分析
   - 眼动系数算法
   - 多维度可视化

### Phase 4: 机器学习模块 (3-4周)

**目标**: 实现完整的ML/DL训练和评估

9. **Module 07: 机器学习** [7天]
   - Scikit-learn模型集成
   - 交叉验证框架
   - 超参数优化
   - 性能评估界面

10. **Module 08: 深度学习** [7天]
    - PyTorch MLP模型(移植旧代码)
    - 训练监控界面
    - TensorBoard集成
    - 模型管理系统

11. **Module 09: 模型评估与服务** [7天]
    - 批量模型评估
    - 残差分析可视化
    - 预测API服务
    - 模型版本管理

### Phase 5: 综合评估系统 (1-2周)

**目标**: Eye-Index综合评估系统

12. **Module 10: Eye-Index** [10天]
    - Eye-Index指标计算
    - 综合报告生成
    - 可视化Dashboard
    - 临床决策支持界面

---

## 💡 技术实现建议

### 前端架构

**技术栈**: React 18 + Vite + Ant Design + Plotly.js

**组件复用策略**:
```
src/components/
├── Charts/                 # 可复用图表组件
│   ├── PlotlyChart.jsx    # ✅ 已完成
│   ├── GazeTrajectoryChart.jsx  # ✅ 已完成
│   ├── HeatmapChart.jsx   # ✅ 已完成
│   ├── RecurrencePlotChart.jsx  # 待开发
│   ├── EventTimelineChart.jsx   # 待开发
│   └── StatisticsPanel.jsx      # 待开发
├── DataLoaders/            # 数据加载组件
│   ├── FileUploader.jsx   # 文件上传
│   ├── DataSelector.jsx   # ✅ 已完成(在Module01中)
│   └── ProgressTracker.jsx # 进度追踪
└── Common/                 # 通用组件
    ├── LoadingSpinner.jsx
    ├── ErrorBoundary.jsx
    └── StatusBadge.jsx
```

### 后端架构

**模块化API设计**:
```
src/web/
├── modules/
│   ├── module00_data_management/
│   │   ├── api.py         # API路由
│   │   ├── service.py     # 业务逻辑
│   │   └── uploader.py    # 文件处理
│   ├── module01_visualization/  # ✅ 已有data_api.py
│   ├── module02_preprocessing/
│   ├── module03_calibration/
│   ├── module04_features/
│   │   ├── rqa/           # 4A子模块
│   │   ├── events/        # 4B子模块
│   │   └── statistics/    # 4C子模块
│   ├── module05_integration/
│   ├── module06_analysis/
│   ├── module07_ml/
│   ├── module08_dl/
│   ├── module09_evaluation/
│   └── module10_eye_index/
└── routes.py              # 主路由注册
```

### 数据层架构

**统一数据接口**:
```python
# src/core/data/
class DataLoader:
    """统一的数据加载接口"""
    @staticmethod
    def load_raw_data(group, subject_id, task_id):
        """加载01_raw数据"""

    @staticmethod
    def load_preprocessed_data(...):
        """加载02_preprocessed数据"""

    @staticmethod
    def load_calibrated_data(...):
        """加载03_calibrated数据"""

    # ... 其他阶段数据加载
```

---

## 🎯 关键决策点

### 决策1: Module01功能保留还是重构?

**选项A (推荐)**: 保留当前Module01,专注"原始数据可视化"
- ✅ 已有完整实现,功能稳定
- ✅ 符合数据流01_raw阶段
- ✅ 可复用chart组件

**选项B**: 重构Module01为"数据导入+可视化"
- ❌ 功能混杂,违反单一职责
- ❌ 需要大量修改已完成代码
- ❌ 与数据流架构不符

**最终决策**: 采用选项A,新增Module00处理数据导入

### 决策2: RQA模块如何组织?

**选项A (推荐)**: 合并旧模块3、5为Module 04-A
- ✅ 功能内聚,同属RQA分析
- ✅ 代码复用,减少冗余
- ✅ 统一参数管理

**选项B**: 保持独立,Module03单次、Module05批量
- ❌ 功能重复,维护困难
- ❌ 用户体验割裂
- ❌ 代码冗余

**最终决策**: 采用选项A,RQA统一在Module 04-A

### 决策3: Module10是否需要独立?

**选项A (推荐)**: 保留Module10作为综合评估入口
- ✅ 符合Eye-Index品牌定位
- ✅ 提供统一的临床视图
- ✅ 整合多模块结果

**选项B**: 取消Module10,功能分散到各模块
- ❌ 失去综合评估能力
- ❌ 用户需要跨模块操作
- ❌ 不利于临床应用

**最终决策**: 采用选项A,Module10作为"皇冠模块"

---

## 📊 工作量估算

### 总体工作量

| 阶段 | 模块数 | 预计工时 | 日历周期 |
|------|--------|----------|----------|
| Phase 1: 数据处理基础 | 3个模块 | 120小时 | 3周 |
| Phase 2: 特征提取核心 | 3个子模块 | 120小时 | 3周 |
| Phase 3: 数据整合与分析 | 2个模块 | 80小时 | 2周 |
| Phase 4: 机器学习模块 | 3个模块 | 160小时 | 4周 |
| Phase 5: 综合评估系统 | 1个模块 | 80小时 | 2周 |
| **总计** | **12个模块** | **560小时** | **14周** |

### 人员配置建议

**单人开发**: 14周(3.5个月)完成
**双人开发**: 7周(1.75个月)完成
**团队开发(3人)**: 5周(1.25个月)完成

---

## ✅ 验收标准

### Module级别验收

每个模块完成需满足:
1. ✅ 前端页面完整实现
2. ✅ 后端API全部可用
3. ✅ 数据流畅通无阻
4. ✅ 单元测试覆盖>70%
5. ✅ 使用文档完整
6. ✅ 与相邻模块集成测试通过

### 项目级别验收

整个项目完成需满足:
1. ✅ 6阶段数据流完全打通
2. ✅ 旧项目核心功能100%覆盖
3. ✅ 性能优于旧项目(特别是RQA GPU加速)
4. ✅ 代码质量达标(无大型单文件)
5. ✅ 文档齐全(API文档、用户手册)
6. ✅ 可部署到生产环境

---

## 📝 附录

### 附录A: 数据目录结构标准

```
data/
├── 01_raw/                    # 原始数据
│   ├── control/
│   ├── mci/
│   └── ad/
├── 02_preprocessed/           # 预处理数据
│   ├── control/
│   ├── mci/
│   └── ad/
├── 03_calibrated/             # 校准数据
│   ├── control/
│   ├── mci/
│   └── ad/
├── 04_features/               # 特征数据
│   ├── rqa/
│   │   └── {m}_tau{tau}_eps{eps}_lmin{lmin}/
│   ├── events/
│   └── statistics/
├── 05_datasets/               # 数据集
│   ├── train/
│   ├── validation/
│   └── test/
├── 06_results/                # 结果
│   ├── analysis/
│   ├── ml_models/
│   ├── dl_models/
│   ├── evaluation/
│   └── eye_index/
└── MMSE_Score/                # MMSE评分(独立)
    └── mmse_scores.csv        # 统一格式
```

### 附录B: API端点命名规范

```
/api/m{模块编号}/{功能}/{操作}

示例:
GET  /api/m00/files/list              # Module00 文件列表
POST /api/m00/files/upload            # Module00 文件上传
GET  /api/m01/data/raw                # Module01 原始数据
GET  /api/m02/preprocessing/status    # Module02 预处理状态
POST /api/m04/rqa/analyze             # Module04 RQA分析
GET  /api/m07/models/list             # Module07 模型列表
```

### 附录C: 前端路由规范

```
/                               # 首页Dashboard
/module00/upload                # Module00 数据上传
/module01/visualization         # Module01 可视化
/module02/preprocessing         # Module02 预处理
/module03/calibration           # Module03 校准
/module04/features              # Module04 特征提取
  /module04/features/rqa        # 4A RQA分析
  /module04/features/events     # 4B 事件检测
  /module04/features/statistics # 4C 统计特征
/module05/integration           # Module05 数据整合
/module06/analysis              # Module06 统计分析
/module07/ml                    # Module07 机器学习
/module08/dl                    # Module08 深度学习
/module09/evaluation            # Module09 模型评估
/module10/eye-index             # Module10 综合评估
```

---

## 🎯 总结

本方案通过**数据流导向的模块重组**,解决了旧项目功能分散、模块重叠的问题,建立了清晰的6阶段数据流架构(00导入 → 01原始 → 02预处理 → 03校准 → 04特征 → 05数据集 → 06-10分析评估)。

**核心优势**:
1. ✅ 模块职责清晰,符合单一职责原则
2. ✅ 数据流向明确,易于理解和维护
3. ✅ 向后兼容旧项目所有功能
4. ✅ 可分阶段实施,降低风险
5. ✅ 为未来扩展留有空间

**下一步行动**:
1. 与用户确认方案
2. 开始Phase 1开发(Module 00/02/03)
3. 并行编写详细的开发文档

---

**文档编制**: Claude AI
**审核状态**: 待用户确认
**版本**: v1.0
**日期**: 2025-10-01
